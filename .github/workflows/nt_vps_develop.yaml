name: NovaTix VPS Develop

# This workflow is designed to deploy the NovaTix application to a VPS server.
on:
  push:
    branches:
      - develop

jobs:
  test-build:
    runs-on: ubuntu-latest
    steps:
      - name: 🛠 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: 📦 Install Frontend Dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps

      - name: 🏗 Build Frontend (Vite)
        run: npm run build

  test-laravel:
    runs-on: ubuntu-latest
    needs: test-build
    steps:
      - name: 🛠 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔧 Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, bcmath, xml, pdo_mysql, pdo_sqlite
          tools: composer, phpunit

      - name: 📦 Install Backend Dependencies
        run: composer install --optimize-autoloader --no-interaction --no-scripts --ignore-platform-reqs

      - name: 🛠 Set Up Laravel Environment
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Install Node.js dependencies
        run: npm ci

      - name: Build frontend assets with Vite
        run: npm run build

      - name: Start Laravel built-in server
        run: php artisan serve --host=127.0.0.1 --port=8000 &

      - name: 🛠 Run Laravel Tests
        run: php artisan test

  vps-sync:
    runs-on: ubuntu-latest
    needs: test-laravel

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/av_rsa
          chmod 600 ~/.ssh/av_rsa
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Ensure Folder Structure & Create Scripts
        run: |
          ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'bash -s' << 'EOF'
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          set -e

          echo "Ensuring folder structure..."
          mkdir -p ~/novatix/app/develop ~/novatix/setups

          # update_repo.sh
          echo "Creating update_repo.sh..."
          cat > ~/novatix/setups/update_repo.sh << 'EOT'
          #!/bin/bash
          mkdir -p ~/novatix/app/develop
          cd ~/novatix

          if [ ! -d "app/develop/.git" ]; then
              echo "Repository not found. Checking existing directory..."
              if [ -n "$(ls -A app 2>/dev/null)" ]; then
                  echo "Existing directory found but not a Git repository. Removing everything..."
                  rm -rf app/develop
              fi
              echo "Cloning repository..."
              git clone --branch develop ${{ secrets.GIT_REPO }} app/develop
          else
              echo "Repository found. Pulling latest changes..."
              cd app/develop

              git reset --hard HEAD
              git clean -fd
              git config --global --add safe.directory ~/novatix/app/develop
              git pull origin develop --force
          fi
          EOT
          chmod +x ~/novatix/setups/update_repo.sh

          # install_dependencies.sh
          echo "Creating install_dependencies.sh..."
          cat > ~/novatix/setups/install_dependencies.sh << 'EOT'
          #!/bin/bash
          set -e
          cd ~/novatix/app/develop

          echo "Installing PHP 8.3 and Composer dependencies..."
          sudo apt update
          sudo apt install software-properties-common -y
          sudo add-apt-repository ppa:ondrej/php -y
          sudo apt update

          echo "Installing required PHP extensions and PHP-FPM..."
          sudo apt install -y php8.3 php8.3-cli php8.3-fpm php8.3-sqlite3 unzip curl git \
          php8.3-dom php8.3-xml php8.3-intl php8.3-curl php8.3-zip php8.3-gd php8.3-mbstring

          echo "Installing Composer..."
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
          rm composer-setup.php

          composer install --no-interaction --prefer-dist --optimize-autoloader
          # Laravel setup
          # If env not exist
          if [ ! -f .env ]; then
              echo "Creating .env file..."
              cp .env.example .env
              php artisan key:generate
          fi

          echo "Installing Node.js and npm..."
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt install -y nodejs

          echo "Installing npm dependencies and building assets..."
          npm install
          npm run build

          # Check if nginx is installed, install if missing
          if ! command -v nginx > /dev/null; then
              echo "Nginx not found, installing..."
              sudo apt update
              sudo apt install -y nginx
              sudo systemctl enable nginx
              sudo systemctl start nginx
          else
              echo "Nginx is already installed."
          fi

          # Install MariaDB server if missing
          if ! systemctl list-units --full -all | grep -q mariadb.service; then
              echo "MariaDB server not found, installing..."
              sudo apt update
              sudo apt install -y mariadb-server
              sudo systemctl enable mariadb
              sudo systemctl start mariadb
          else
              echo "MariaDB server already installed."
          fi

          # Install PHP MySQL extension if missing
          if ! dpkg -l | grep -q php8.3-mysql; then
              echo "Installing PHP MySQL extension..."
              sudo apt update
              sudo apt install -y php8.3-mysql
              # Restart php-fpm to apply new extension
              sudo systemctl restart php8.3-fpm
          else
              echo "PHP MySQL extension already installed."
          fi

          # Path to nginx config inside your repo
          REPO_NGINX_CONF=~/novatix/app/develop/nginx.conf
          NGINX_CONF_PATH=/etc/nginx/sites-available/novatix
          NGINX_ENABLED_PATH=/etc/nginx/sites-enabled/novatix

          if [ ! -f "$NGINX_CONF_PATH" ]; then
              echo "Nginx config not found in sites-available, copying from repo..."
              sudo cp "$REPO_NGINX_CONF" "$NGINX_CONF_PATH"
              echo "Creating symlink in sites-enabled..."
              sudo ln -sf "$NGINX_CONF_PATH" "$NGINX_ENABLED_PATH"
              echo "Testing nginx config..."
              sudo nginx -t
              echo "Reloading nginx service..."
              sudo systemctl reload nginx
          else
              echo "Nginx config already exists at $NGINX_CONF_PATH, skipping..."
          fi

          # Install certbot and python3-certbot-nginx if missing
          if ! command -v certbot > /dev/null; then
              echo "Certbot not found, installing certbot and python3-certbot-nginx..."
              sudo apt update
              sudo apt install -y certbot python3-certbot-nginx
          else
              echo "Certbot already installed."
          fi

          EOT
          chmod +x ~/novatix/setups/install_dependencies.sh

          # deploy_laravel.sh
          echo "Creating deploy_laravel.sh..."
          cat > ~/novatix/setups/deploy_laravel.sh << 'EOT'
          #!/bin/bash
          cd ~/novatix/app/develop
          sudo php artisan config:clear
          sudo php artisan cache:clear
          sudo php artisan route:cache
          EOT
          chmod +x ~/novatix/setups/deploy_laravel.sh

          # restart_services.sh
          echo "Creating restart_services.sh..."
          cat > ~/novatix/setups/restart_services.sh << 'EOT'
          #!/bin/bash
          sudo systemctl restart php8.3-fpm
          EOT
          chmod +x ~/novatix/setups/restart_services.sh

          EOF

      - name: Update Repository on VPS
        run: ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "~/novatix/setups/update_repo.sh"

      - name: Install Dependencies on VPS
        run: ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "~/novatix/setups/install_dependencies.sh"

      - name: Restart PHP-FPM and reload Nginx
        run: |
          ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            sudo systemctl restart php8.3-fpm
            sudo systemctl reload nginx
          EOF

      - name: Deploy Laravel on VPS
        run: ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "~/novatix/setups/deploy_laravel.sh"

      - name: Restart Services on VPS
        run: ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "~/novatix/setups/restart_services.sh"

      - name: Deploy Laravel Project to VPS
        run: |
          ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'bash -s' << 'EOF'
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # Define directory paths
          PROD_DIR=~/novatix/app/production
          SYMLINK_PATH=/var/www/novatix

          # Ensure directory exists
          mkdir -p "$PROD_DIR"

          # Link to /var/www/novatix
          sudo rm -rf "$SYMLINK_PATH"
          sudo ln -s "$PROD_DIR" "$SYMLINK_PATH"
          sudo chown -R www-data:www-data "$SYMLINK_PATH"
          cd "$SYMLINK_PATH"

          # Run deployment commands
          composer install --no-interaction --prefer-dist --optimize-autoloader
          sudo npm install
          sudo npm run build
          sudo php artisan migrate --force
          sudo php artisan storage:link

          echo "Fixing Laravel directory permissions..."
          mkdir -p storage/framework/{cache,sessions,views}
          mkdir -p storage/logs bootstrap/cache

          sudo chown -R www-data:www-data storage bootstrap/cache
          sudo find storage -type d -exec chmod 775 {} \;
          sudo find storage -type f -exec chmod 664 {} \;
          sudo chmod -R 775 bootstrap/cache

          sudo php artisan config:clear
          sudo php artisan config:cache
          sudo php artisan route:cache
          sudo php artisan view:cache

          EOF

