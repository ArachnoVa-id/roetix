name: NovaTix VPS Develop

on:
  push:
    branches:
      - develop

jobs:
  # test-build:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: 🛠 Checkout Repository
  #       uses: actions/checkout@v4

  #     - name: 🔧 Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 'lts/*'
  #         cache: 'npm'

  #     - name: 📦 Install Frontend Dependencies
  #       run: |
  #         rm -rf node_modules package-lock.json
  #         npm install --legacy-peer-deps

  #     - name: 🏗 Build Frontend (Vite)
  #       run: npm run build

  # test-laravel:
  #   runs-on: ubuntu-latest
  #   needs: test-build # Run Laravel tests after Vite build
  #   steps:
  #     - name: 🛠 Checkout Repository
  #       uses: actions/checkout@v4

  #     - name: 🔧 Setup PHP
  #       uses: shivammathur/setup-php@v2
  #       with:
  #         php-version: 8.2
  #         extensions: mbstring, bcmath, xml, pdo_mysql
  #         tools: composer, phpunit

  #     - name: 📦 Install Backend Dependencies
  #       run: composer install --no-dev --optimize-autoloader

  #     - name: 🛠 Set Up Laravel Environment
  #       run: |
  #         cp .env.example .env
  #         php artisan key:generate

  #     - name: 🛠 Run Laravel Tests
  #       run: php artisan test

  vps_sync:
    runs-on: ubuntu-latest
    # needs: test-laravel # Deploy only if Laravel tests pass

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/av_rsa
          chmod 600 ~/.ssh/av_rsa
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Ensure Folder Structure & Create Scripts
        run: |
          ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'bash -s' << 'EOF'
          set -e

          echo "Ensuring folder structure..."
          mkdir -p ~/novatix/app/develop ~/novatix/setups

          # Ensure update_repo.sh exists
          echo "Creating update_repo.sh..."
          cat > ~/novatix/setups/update_repo.sh << 'EOT'
          #!/bin/bash
          mkdir -p ~/novatix/app/develop
          cd ~/novatix

          if [ ! -d "app/.git" ]; then
              echo "Repository not found. Checking existing directory..."

              if [ -n "$(ls -A app 2>/dev/null)" ]; then
                  echo "Existing directory found but not a Git repository. Removing everything..."
                  rm -rf app
              fi

              echo "Cloning repository..."
              git clone git@github.com:ArachnoVa-id/novatix.git app
          else
              echo "Repository found. Pulling latest changes..."
              cd app
              git pull origin main
          fi

          ls -la  # Debugging: Show contents
          EOT
              chmod +x ~/novatix/setups/update_repo.sh

              # Ensure install_dependencies.sh exists
              echo "Creating install_dependencies.sh..."
              cat > ~/novatix/setups/install_dependencies.sh << 'EOT'
          #!/bin/bash
          cd ~/novatix/app/develop
          composer install --no-interaction --prefer-dist
          EOT
              chmod +x ~/novatix/setups/install_dependencies.sh

              # Ensure deploy_laravel.sh exists
              echo "Creating deploy_laravel.sh..."
              cat > ~/novatix/setups/deploy_laravel.sh << 'EOT'
          #!/bin/bash
          cd ~/novatix/app/develop
          php artisan migrate --force --seed
          php artisan config:clear
          php artisan cache:clear
          php artisan route:cache
          EOT
              chmod +x ~/novatix/setups/deploy_laravel.sh

              # Ensure restart_services.sh exists
              echo "Creating restart_services.sh..."
              cat > ~/novatix/setups/restart_services.sh << 'EOT'
          #!/bin/bash
          sudo systemctl restart php8.1-fpm
          EOT
              chmod +x ~/novatix/setups/restart_services.sh

              # Auto-generate .env if missing
              echo "Checking .env file..."
              if [ ! -f ~/novatix/app/develop/.env ]; then
                  echo "Generating .env file..."
                  cat > ~/novatix/app/develop/.env << EOT
          APP_NAME=${{ vars.APP_NAME }}
          APP_ENV=${{ vars.APP_ENV }}
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=${{ vars.APP_DEBUG }}
          APP_TIMEZONE=${{ vars.APP_TIMEZONE }}
          APP_URL=${{ secrets.APP_URL }}

          APP_LOCALE=${{ vars.APP_LOCALE }}
          APP_FALLBACK_LOCALE=${{ vars.APP_FALLBACK_LOCALE }}
          APP_FAKER_LOCALE=${{ vars.APP_FAKER_LOCALE }}

          APP_MAINTENANCE_DRIVER=${{ vars.APP_MAINTENANCE_DRIVER }}
          PHP_CLI_SERVER_WORKERS=${{ vars.PHP_CLI_SERVER_WORKERS }}

          BCRYPT_ROUNDS=${{ vars.BCRYPT_ROUNDS }}

          LOG_CHANNEL=${{ vars.LOG_CHANNEL }}
          LOG_STACK=${{ vars.LOG_STACK }}
          LOG_DEPRECATIONS_CHANNEL=${{ vars.LOG_DEPRECATIONS_CHANNEL }}
          LOG_LEVEL=${{ vars.LOG_LEVEL }}

          DB_CONNECTION=${{ vars.DB_CONNECTION }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          SESSION_DRIVER=${{ vars.SESSION_DRIVER }}
          SESSION_LIFETIME=${{ vars.SESSION_LIFETIME }}
          SESSION_ENCRYPT=${{ vars.SESSION_ENCRYPT }}
          SESSION_PATH=${{ vars.SESSION_PATH }}
          SESSION_DOMAIN=${{ vars.SESSION_DOMAIN }}

          BROADCAST_CONNECTION=${{ vars.BROADCAST_CONNECTION }}
          FILESYSTEM_DISK=${{ vars.FILESYSTEM_DISK }}
          QUEUE_CONNECTION=${{ vars.QUEUE_CONNECTION }}

          CACHE_STORE=${{ vars.CACHE_STORE }}
          CACHE_PREFIX=${{ vars.CACHE_PREFIX }}

          MEMCACHED_HOST=${{ vars.MEMCACHED_HOST }}

          REDIS_CLIENT=${{ vars.REDIS_CLIENT }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}

          MAIL_MAILER=${{ vars.MAIL_MAILER }}
          MAIL_SCHEME=${{ vars.MAIL_SCHEME }}
          MAIL_HOST=${{ secrets.MAIL_HOST }}
          MAIL_PORT=${{ secrets.MAIL_PORT }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}
          MAIL_FROM_NAME=${{ vars.APP_NAME }}

          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION=${{ vars.AWS_DEFAULT_REGION }}
          AWS_BUCKET=${{ secrets.AWS_BUCKET }}
          AWS_USE_PATH_STYLE_ENDPOINT=${{ vars.AWS_USE_PATH_STYLE_ENDPOINT }}

          VITE_APP_NAME=${{ vars.APP_NAME }}
          EOT
                  chmod 600 ~/novatix/app/develop/.env
              fi
          EOF

      - name: Update Repository on VPS
        run: ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "~/novatix/setups/update_repo.sh"

      - name: Install Dependencies on VPS
        run: ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "~/novatix/setups/install_dependencies.sh"

      - name: Deploy Laravel on VPS
        run: ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "~/novatix/setups/deploy_laravel.sh"

      - name: Restart Services on VPS
        run: ssh -i ~/.ssh/av_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "~/novatix/setups/restart_services.sh"
